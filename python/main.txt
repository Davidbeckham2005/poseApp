import cv2
import mediapipe as mp
from mediapipe.tasks import python
from mediapipe.tasks.python import vision

# mp_drawing = mp.solutions.drawing_utils
# mp_pose = mp.solutions.pose
base_options = python.BaseOptions(model_asset_path='C:/Users/dinhh/Desktop/nienluan/PoseApp/src-tauri/python/pose_landmarker_full.task')

options = vision.PoseLandmarkerOptions(
    base_options=base_options,
    running_mode=vision.RunningMode.VIDEO,
    num_poses=1,
    min_pose_detection_confidence=0.5,
    min_pose_presence_confidence=0.5,
    min_tracking_confidence=0.5,
    output_segmentation_masks=False,
)
CONNECTIONS = [
            (11, 12), (11, 13), (13, 15), (12, 14), (14, 16), # Tay & Vai
            (11, 23), (12, 24), (23, 24),                   # Thân
            (23, 25), (25, 27), (24, 26), (26, 28)          # Chân (Quan trọng cho Squat)
        ]
with vision.PoseLandmarker.create_from_options(options) as landmarker:
    capture = cv2.VideoCapture("C:/Users/dinhh/Downloads/squat01.mp4")

    while capture.isOpened():
        landmarks_px = []

        ret,frame = capture.read()
        if not ret:
            break
        rgb_frame = cv2.cvtColor(frame,cv2.COLOR_BGR2RGB)
        mp_image = mp.Image(
            image_format=mp.ImageFormat.SRGB,
            data= rgb_frame
            )
        frame_time_stamp_ms = int(capture.get(cv2.CAP_PROP_POS_MSEC))

        result = landmarker.detect_for_video(mp_image,frame_time_stamp_ms)
        h, w, _ = frame.shape
        if result.pose_landmarks:
            pose_landmarks = result.pose_landmarks[0]
            for lm in pose_landmarks:
                landmarks_px.append((int(lm.x * w), int(lm.y * h)))
        # Đóng gói dữ liệu vào "khuôn" Protobuf
            # pose_landmarks_proto = landmark_pb2.NormalizedLandmarkList()
            # pose_landmarks_proto.landmark.extend([
            #     landmark_pb2.NormalizedLandmark(x=lm.x, y=lm.y, z=lm.z) for lm in pose_landmarks
            # ])
            # print(pose_landmarks[0])
        # Vẽ khung xương
            # mp_drawing.draw_landmarks(
            # frame,
            # pose_landmarks_proto,
            # mp_pose.POSE_CONNECTIONS,
                
            # )

            for connection in CONNECTIONS:
                start_idx, end_idx = connection
                pt1 = landmarks_px[start_idx]
                pt2 = landmarks_px[end_idx]
            
            # Vẽ đường xương (Màu xanh lá)
                cv2.line(frame, pt1, pt2, (0, 255, 0), 2)

        # 3. Vẽ các khớp tròn (Joints)
            for pt in landmarks_px:
            # Chỉ vẽ các điểm chính (từ vai trở xuống) để tránh rối mắt
                cv2.circle(frame, pt, 4, (0, 0, 255), -1)
        cv2.imshow("c",frame)
        if cv2.waitKey(20) & 0xFF == ord('q'):
            break

capture.release()
cv2.destroyAllWindows()